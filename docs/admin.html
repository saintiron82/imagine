<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin — Imagine</title>
<meta name="theme-color" content="#0a0a1a">
<link rel="icon" href="icon.svg" type="image/svg+xml">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="common.css">
<style>
/* ── Layout ──────────────────────────────────────────── */
.admin-wrapper {
  max-width: 960px; margin: 0 auto;
  padding: 100px 24px 80px;
  min-height: calc(100vh - 64px);
}

/* ── Login ────────────────────────────────────────────── */
.login-section {
  display: flex; flex-direction: column; align-items: center;
  justify-content: center; min-height: 60vh; text-align: center;
}
.login-section .icon { font-size: 3rem; margin-bottom: 16px; }
.login-section h2 { font-size: 1.6rem; font-weight: 700; margin-bottom: 8px; }
.login-section p { color: #6b7280; margin-bottom: 28px; font-size: 0.95rem; }
.google-btn {
  display: inline-flex; align-items: center; gap: 10px;
  padding: 12px 28px; border-radius: 10px; font-size: 0.95rem;
  font-weight: 600; font-family: inherit; cursor: pointer;
  background: #fff; color: #333; border: none;
  box-shadow: 0 2px 8px rgba(0,0,0,0.2);
  transition: all 0.2s;
}
.google-btn:hover { box-shadow: 0 4px 16px rgba(0,0,0,0.3); transform: translateY(-1px); }
.google-btn svg { width: 20px; height: 20px; }

/* ── Tabs ─────────────────────────────────────────────── */
.admin-tabs {
  display: flex; gap: 4px; margin-bottom: 32px;
  border-bottom: 1px solid rgba(255,255,255,0.08);
}
.admin-tab {
  padding: 12px 20px; font-size: 0.9rem; font-weight: 500;
  color: #6b7280; cursor: pointer; border: none; background: none;
  font-family: inherit; transition: all 0.2s;
  border-bottom: 2px solid transparent; margin-bottom: -1px;
}
.admin-tab:hover { color: #e0e0ee; }
.admin-tab.active { color: #38bdf8; border-bottom-color: #38bdf8; }

/* ── User Bar ────────────────────────────────────────── */
.user-bar {
  display: flex; justify-content: space-between; align-items: center;
  margin-bottom: 24px; padding: 12px 16px;
  background: rgba(255,255,255,0.03); border-radius: 10px;
  border: 1px solid rgba(255,255,255,0.06);
}
.user-info { display: flex; align-items: center; gap: 10px; }
.user-avatar { width: 32px; height: 32px; border-radius: 50%; }
.user-name { font-size: 0.9rem; font-weight: 500; }
.user-email { font-size: 0.75rem; color: #6b7280; }
.logout-btn {
  padding: 6px 14px; border-radius: 8px; font-size: 0.8rem;
  font-weight: 500; font-family: inherit; cursor: pointer;
  background: rgba(248,113,113,0.1); color: #f87171;
  border: 1px solid rgba(248,113,113,0.2);
  transition: all 0.2s;
}
.logout-btn:hover { background: rgba(248,113,113,0.2); }

/* ── Panel ────────────────────────────────────────────── */
.admin-panel { display: none; }
.admin-panel.active { display: block; }

/* ── List ─────────────────────────────────────────────── */
.item-list { margin-bottom: 24px; }
.item-row {
  display: flex; align-items: center; justify-content: space-between;
  padding: 12px 16px;
  border-bottom: 1px solid rgba(255,255,255,0.04);
  transition: background 0.2s;
}
.item-row:hover { background: rgba(255,255,255,0.02); }
.item-row .meta { display: flex; gap: 12px; align-items: center; }
.item-row .meta .tag {
  font-size: 0.7rem; padding: 2px 8px; border-radius: 12px;
  font-weight: 600; text-transform: uppercase;
}
.tag.major { background: rgba(248,113,113,0.15); color: #f87171; }
.tag.minor { background: rgba(56,189,248,0.15); color: #38bdf8; }
.tag.patch { background: rgba(52,211,153,0.15); color: #34d399; }
.item-row .title { font-weight: 500; font-size: 0.9rem; }
.item-row .date { font-size: 0.8rem; color: #6b7280; }
.item-actions { display: flex; gap: 6px; }
.icon-btn {
  padding: 6px 10px; border-radius: 6px; font-size: 0.85rem;
  cursor: pointer; border: none; font-family: inherit;
  background: rgba(255,255,255,0.05); color: #9ca3bf;
  transition: all 0.2s;
}
.icon-btn:hover { background: rgba(255,255,255,0.1); color: #e0e0ee; }
.icon-btn.danger { color: #f87171; }
.icon-btn.danger:hover { background: rgba(248,113,113,0.15); }

/* ── Form ─────────────────────────────────────────────── */
.editor-form {
  background: rgba(255,255,255,0.03);
  border: 1px solid rgba(255,255,255,0.08);
  border-radius: 14px; padding: 24px;
  margin-bottom: 24px;
}
.editor-form h3 { font-size: 1.1rem; font-weight: 600; margin-bottom: 20px; }
.form-row {
  display: grid; grid-template-columns: 1fr 1fr;
  gap: 16px; margin-bottom: 16px;
}
.form-group { display: flex; flex-direction: column; gap: 6px; }
.form-group.full { grid-column: 1 / -1; }
.form-group label {
  font-size: 0.8rem; font-weight: 500; color: #9ca3bf;
}
.form-group input, .form-group select, .form-group textarea {
  padding: 10px 14px; border-radius: 8px; font-size: 0.9rem;
  font-family: inherit; color: #e0e0ee;
  background: rgba(0,0,0,0.3);
  border: 1px solid rgba(255,255,255,0.1);
  transition: border-color 0.2s;
}
.form-group input:focus, .form-group select:focus, .form-group textarea:focus {
  outline: none; border-color: #38bdf8;
}
.form-group textarea {
  min-height: 200px; resize: vertical;
  font-family: 'SF Mono', 'Fira Code', monospace;
  font-size: 0.85rem; line-height: 1.6;
}
.form-actions {
  display: flex; gap: 10px; justify-content: flex-end;
  margin-top: 16px;
}
.form-actions button {
  padding: 10px 20px; border-radius: 8px; font-size: 0.85rem;
  font-weight: 600; font-family: inherit; cursor: pointer;
  border: none; transition: all 0.2s;
}
.btn-save {
  background: linear-gradient(135deg, #38bdf8, #818cf8);
  color: #fff; box-shadow: 0 0 12px rgba(56,189,248,0.2);
}
.btn-save:hover { box-shadow: 0 0 20px rgba(56,189,248,0.3); }
.btn-cancel {
  background: rgba(255,255,255,0.06); color: #9ca3bf;
  border: 1px solid rgba(255,255,255,0.1);
}
.btn-cancel:hover { background: rgba(255,255,255,0.1); }
.btn-add {
  padding: 10px 20px; border-radius: 8px; font-size: 0.85rem;
  font-weight: 600; font-family: inherit; cursor: pointer;
  border: 1px dashed rgba(255,255,255,0.15);
  background: rgba(255,255,255,0.02); color: #9ca3bf;
  transition: all 0.2s; width: 100%;
}
.btn-add:hover { border-color: #38bdf8; color: #38bdf8; background: rgba(56,189,248,0.05); }

/* ── Preview ─────────────────────────────────────────── */
.preview-toggle {
  padding: 6px 14px; border-radius: 6px; font-size: 0.8rem;
  font-weight: 500; font-family: inherit; cursor: pointer;
  background: rgba(56,189,248,0.1); color: #38bdf8;
  border: 1px solid rgba(56,189,248,0.2);
  transition: all 0.2s; margin-bottom: 12px;
}
.preview-toggle:hover { background: rgba(56,189,248,0.2); }
.preview-box {
  background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.08);
  border-radius: 10px; padding: 20px; min-height: 100px;
  display: none;
}
.preview-box.open { display: block; }

/* ── Toast ────────────────────────────────────────────── */
.toast {
  position: fixed; bottom: 24px; right: 24px;
  padding: 12px 20px; border-radius: 10px;
  font-size: 0.85rem; font-weight: 500;
  z-index: 200; transform: translateY(100px);
  transition: transform 0.3s ease;
}
.toast.show { transform: translateY(0); }
.toast.success { background: rgba(52,211,153,0.15); color: #34d399; border: 1px solid rgba(52,211,153,0.3); }
.toast.error { background: rgba(248,113,113,0.15); color: #f87171; border: 1px solid rgba(248,113,113,0.3); }

/* ── Responsive ──────────────────────────────────────── */
@media (max-width: 640px) {
  .form-row { grid-template-columns: 1fr; }
  .user-bar { flex-direction: column; gap: 12px; text-align: center; }
}
</style>
</head>
<body>

<div class="ambient"></div>

<!-- Nav -->
<nav>
  <div class="nav-inner">
    <a href="index.html" class="nav-brand">
      <img src="icon.svg" alt="Imagine">
      <span>Imagine</span>
    </a>
    <div class="nav-links">
      <a href="releases.html" class="nav-page-link" data-i18n="nav.releases">Releases</a>
      <a href="guide.html" class="nav-page-link" data-i18n="nav.guide">Guide</a>
      <a href="qna.html" class="nav-page-link" data-i18n="nav.qna">Q&A</a>
      <a href="index.html#download" class="nav-page-link" data-i18n="nav.download">Download</a>
      <div class="lang-toggle">
        <button class="lang-btn active" onclick="setLang('en')">EN</button>
        <button class="lang-btn" onclick="setLang('ko')">KO</button>
      </div>
    </div>
  </div>
</nav>

<!-- Admin Wrapper -->
<div class="admin-wrapper">

  <!-- Login Section (shown when not authenticated) -->
  <div id="login-section" class="login-section">
    <div class="icon">&#128274;</div>
    <h2 data-i18n="admin.title">Admin Panel</h2>
    <p data-i18n="admin.login_desc">Sign in with Google to manage content</p>
    <button class="google-btn" onclick="signIn()">
      <svg viewBox="0 0 24 24"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92a5.06 5.06 0 01-2.2 3.32v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.1z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
      <span data-i18n="admin.sign_in">Sign in with Google</span>
    </button>
  </div>

  <!-- Admin Dashboard (shown when authenticated) -->
  <div id="admin-dashboard" style="display: none;">

    <!-- User Bar -->
    <div class="user-bar">
      <div class="user-info">
        <img id="user-avatar" class="user-avatar" src="" alt="">
        <div>
          <div id="user-name" class="user-name"></div>
          <div id="user-email" class="user-email"></div>
        </div>
      </div>
      <button class="logout-btn" onclick="signOut()" data-i18n="admin.sign_out">Sign Out</button>
    </div>

    <!-- Tabs -->
    <div class="admin-tabs">
      <button class="admin-tab active" onclick="switchTab('releases')" data-i18n="admin.tab_releases">Releases</button>
      <button class="admin-tab" onclick="switchTab('guide')" data-i18n="admin.tab_guide">Guide</button>
    </div>

    <!-- Releases Panel -->
    <div id="panel-releases" class="admin-panel active">
      <div id="releases-list" class="item-list"></div>
      <div id="releases-editor" style="display: none;"></div>
      <button class="btn-add" onclick="newRelease()" data-i18n="admin.add_release">+ Add Release</button>
    </div>

    <!-- Guide Panel -->
    <div id="panel-guide" class="admin-panel">
      <h3 style="margin-bottom: 16px; font-size: 0.9rem; color: #6b7280;" data-i18n="admin.categories">Categories</h3>
      <div id="categories-list" class="item-list"></div>
      <button class="btn-add" onclick="newCategory()" data-i18n="admin.add_category" style="margin-bottom: 32px;">+ Add Category</button>
      <div id="category-editor" style="display: none;"></div>

      <h3 style="margin-bottom: 16px; font-size: 0.9rem; color: #6b7280;" data-i18n="admin.articles">Articles</h3>
      <div id="articles-list" class="item-list"></div>
      <button class="btn-add" onclick="newArticle()" data-i18n="admin.add_article">+ Add Article</button>
      <div id="article-editor" style="display: none;"></div>
    </div>
  </div>
</div>

<!-- Toast -->
<div id="toast" class="toast"></div>

<!-- Footer -->
<footer>
  <div class="container">
    <p>&copy; 2026 Imagine &middot; Open Source &middot; Apache 2.0</p>
  </div>
</footer>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
<script src="common.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked@15/marked.min.js"></script>

<script>
/* ── Page i18n ───────────────────────────────────────── */
registerPageI18n({
  en: {
    "admin.title": "Admin Panel",
    "admin.login_desc": "Sign in with Google to manage content",
    "admin.sign_in": "Sign in with Google",
    "admin.sign_out": "Sign Out",
    "admin.tab_releases": "Releases",
    "admin.tab_guide": "Guide",
    "admin.add_release": "+ Add Release",
    "admin.add_category": "+ Add Category",
    "admin.add_article": "+ Add Article",
    "admin.categories": "Categories",
    "admin.articles": "Articles",
    "admin.save": "Save",
    "admin.cancel": "Cancel",
    "admin.delete_confirm": "Are you sure you want to delete this?",
    "admin.saved": "Saved successfully",
    "admin.deleted": "Deleted successfully",
    "admin.save_error": "Save failed",
    "admin.preview": "Preview",
    "admin.no_permission": "You do not have admin permission"
  },
  ko: {
    "admin.title": "\uad00\ub9ac\uc790 \ud328\ub110",
    "admin.login_desc": "Google\ub85c \ub85c\uadf8\uc778\ud558\uc5ec \ucf58\ud150\uce20\ub97c \uad00\ub9ac\ud558\uc138\uc694",
    "admin.sign_in": "Google\ub85c \ub85c\uadf8\uc778",
    "admin.sign_out": "\ub85c\uadf8\uc544\uc6c3",
    "admin.tab_releases": "\ub9b4\ub9ac\uc2a4",
    "admin.tab_guide": "\uac00\uc774\ub4dc",
    "admin.add_release": "+ \ub9b4\ub9ac\uc2a4 \ucd94\uac00",
    "admin.add_category": "+ \uce74\ud14c\uace0\ub9ac \ucd94\uac00",
    "admin.add_article": "+ \ubb38\uc11c \ucd94\uac00",
    "admin.categories": "\uce74\ud14c\uace0\ub9ac",
    "admin.articles": "\ubb38\uc11c",
    "admin.save": "\uc800\uc7a5",
    "admin.cancel": "\ucde8\uc18c",
    "admin.delete_confirm": "\uc815\ub9d0 \uc0ad\uc81c\ud558\uc2dc\uaca0\uc2b5\ub2c8\uae4c?",
    "admin.saved": "\uc800\uc7a5\ub418\uc5c8\uc2b5\ub2c8\ub2e4",
    "admin.deleted": "\uc0ad\uc81c\ub418\uc5c8\uc2b5\ub2c8\ub2e4",
    "admin.save_error": "\uc800\uc7a5 \uc2e4\ud328",
    "admin.preview": "\ubbf8\ub9ac\ubcf4\uae30",
    "admin.no_permission": "\uad00\ub9ac\uc790 \uad8c\ud55c\uc774 \uc5c6\uc2b5\ub2c8\ub2e4"
  }
});

/* ── State ───────────────────────────────────────────── */
let currentUser = null;
let releases = [];
let guideCategories = [];
let guideArticles = [];

/* ── Auth ─────────────────────────────────────────────── */
function signIn() {
  const auth = getAuth();
  if (!auth) return;
  const provider = new firebase.auth.GoogleAuthProvider();
  auth.signInWithPopup(provider).catch(err => {
    console.error('Sign in failed:', err);
    showToast(err.message, 'error');
  });
}

function signOut() {
  const auth = getAuth();
  if (auth) auth.signOut();
}

// Auth state listener
function initAuth() {
  const auth = getAuth();
  if (!auth) return;

  auth.onAuthStateChanged(user => {
    currentUser = user;
    if (user) {
      document.getElementById('login-section').style.display = 'none';
      document.getElementById('admin-dashboard').style.display = 'block';
      document.getElementById('user-avatar').src = user.photoURL || '';
      document.getElementById('user-name').textContent = user.displayName || '';
      document.getElementById('user-email').textContent = user.email || '';
      loadAllData();
    } else {
      document.getElementById('login-section').style.display = 'flex';
      document.getElementById('admin-dashboard').style.display = 'none';
    }
  });
}

/* ── Tab Switch ──────────────────────────────────────── */
function switchTab(tab) {
  document.querySelectorAll('.admin-tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.admin-panel').forEach(p => p.classList.remove('active'));
  event.target.classList.add('active');
  document.getElementById('panel-' + tab).classList.add('active');
}

/* ── Load Data ───────────────────────────────────────── */
async function loadAllData() {
  const db = getDb();
  if (!db) return;

  try {
    const [relSnap, catSnap, artSnap] = await Promise.all([
      db.collection('releases').orderBy('order', 'asc').get(),
      db.collection('guide_categories').orderBy('order', 'asc').get(),
      db.collection('guide_articles').orderBy('order', 'asc').get()
    ]);

    releases = relSnap.docs.map(d => ({ id: d.id, ...d.data() }));
    guideCategories = catSnap.docs.map(d => ({ id: d.id, ...d.data() }));
    guideArticles = artSnap.docs.map(d => ({ id: d.id, ...d.data() }));

    renderReleasesList();
    renderCategoriesList();
    renderArticlesList();
  } catch (err) {
    console.error('Load error:', err);
    showToast(t('common.error'), 'error');
  }
}

/* ══════════════════════════════════════════════════════
   RELEASES CRUD
   ══════════════════════════════════════════════════════ */

function renderReleasesList() {
  const container = document.getElementById('releases-list');
  container.innerHTML = releases.map(rel => `
    <div class="item-row">
      <div class="meta">
        <span class="tag ${rel.type || 'minor'}">${rel.type || 'minor'}</span>
        <span class="title">${rel.version} — ${rel.title_en || ''}</span>
        <span class="date">${rel.date || ''}</span>
      </div>
      <div class="item-actions">
        <button class="icon-btn" onclick="editRelease('${rel.id}')">&#9998;</button>
        <button class="icon-btn danger" onclick="deleteRelease('${rel.id}')">&#128465;</button>
      </div>
    </div>`).join('') || '<div style="padding: 20px; color: #6b7280; text-align: center;">No releases</div>';
}

function newRelease() {
  showReleaseEditor(null);
}

function editRelease(id) {
  const rel = releases.find(r => r.id === id);
  if (rel) showReleaseEditor(rel);
}

function showReleaseEditor(rel) {
  const editor = document.getElementById('releases-editor');
  const isNew = !rel;
  const nextOrder = isNew ? (releases.length > 0 ? Math.max(...releases.map(r => r.order || 0)) + 1 : 1) : rel.order;

  editor.style.display = 'block';
  editor.innerHTML = `
    <div class="editor-form">
      <h3>${isNew ? 'New Release' : 'Edit Release'}</h3>
      <div class="form-row">
        <div class="form-group">
          <label>Version</label>
          <input id="rel-version" value="${rel ? rel.version : ''}" placeholder="v0.6.0">
        </div>
        <div class="form-group">
          <label>Date</label>
          <input id="rel-date" type="date" value="${rel ? rel.date : new Date().toISOString().split('T')[0]}">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Type</label>
          <select id="rel-type">
            <option value="major" ${rel && rel.type === 'major' ? 'selected' : ''}>Major</option>
            <option value="minor" ${!rel || rel.type === 'minor' ? 'selected' : ''}>Minor</option>
            <option value="patch" ${rel && rel.type === 'patch' ? 'selected' : ''}>Patch</option>
          </select>
        </div>
        <div class="form-group">
          <label>Order</label>
          <input id="rel-order" type="number" value="${nextOrder}">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Title (EN)</label>
          <input id="rel-title-en" value="${rel ? (rel.title_en || '') : ''}" placeholder="Release title in English">
        </div>
        <div class="form-group">
          <label>Title (KO)</label>
          <input id="rel-title-ko" value="${rel ? (rel.title_ko || '') : ''}" placeholder="\ub9b4\ub9ac\uc2a4 \uc81c\ubaa9 (\ud55c\uad6d\uc5b4)">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group full">
          <label>Content (EN) — Markdown</label>
          <button class="preview-toggle" onclick="togglePreview('rel-preview-en', 'rel-content-en')">${t('admin.preview')}</button>
          <textarea id="rel-content-en" oninput="updatePreview('rel-preview-en', this.value)">${rel ? (rel.content_en || '') : ''}</textarea>
          <div id="rel-preview-en" class="preview-box md-content"></div>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group full">
          <label>Content (KO) — Markdown</label>
          <button class="preview-toggle" onclick="togglePreview('rel-preview-ko', 'rel-content-ko')">${t('admin.preview')}</button>
          <textarea id="rel-content-ko" oninput="updatePreview('rel-preview-ko', this.value)">${rel ? (rel.content_ko || '') : ''}</textarea>
          <div id="rel-preview-ko" class="preview-box md-content"></div>
        </div>
      </div>
      <div class="form-actions">
        <button class="btn-cancel" onclick="hideReleaseEditor()">${t('admin.cancel')}</button>
        <button class="btn-save" onclick="saveRelease('${rel ? rel.id : ''}')">${t('admin.save')}</button>
      </div>
    </div>`;
}

function hideReleaseEditor() {
  document.getElementById('releases-editor').style.display = 'none';
}

async function saveRelease(id) {
  const db = getDb();
  if (!db) return;

  const data = {
    version: document.getElementById('rel-version').value.trim(),
    date: document.getElementById('rel-date').value,
    type: document.getElementById('rel-type').value,
    order: parseInt(document.getElementById('rel-order').value) || 1,
    title_en: document.getElementById('rel-title-en').value.trim(),
    title_ko: document.getElementById('rel-title-ko').value.trim(),
    content_en: document.getElementById('rel-content-en').value,
    content_ko: document.getElementById('rel-content-ko').value
  };

  try {
    if (id) {
      await db.collection('releases').doc(id).update(data);
    } else {
      data.created_at = firebase.firestore.FieldValue.serverTimestamp();
      const docId = data.version.replace(/\./g, '_').replace(/^v/, 'v');
      await db.collection('releases').doc(docId).set(data);
    }
    showToast(t('admin.saved'), 'success');
    hideReleaseEditor();
    await loadAllData();
  } catch (err) {
    console.error('Save error:', err);
    showToast(t('admin.save_error') + ': ' + err.message, 'error');
  }
}

async function deleteRelease(id) {
  if (!confirm(t('admin.delete_confirm'))) return;
  const db = getDb();
  if (!db) return;

  try {
    await db.collection('releases').doc(id).delete();
    showToast(t('admin.deleted'), 'success');
    await loadAllData();
  } catch (err) {
    showToast(t('admin.save_error') + ': ' + err.message, 'error');
  }
}

/* ══════════════════════════════════════════════════════
   GUIDE CATEGORIES CRUD
   ══════════════════════════════════════════════════════ */

function renderCategoriesList() {
  const container = document.getElementById('categories-list');
  container.innerHTML = guideCategories.map(cat => `
    <div class="item-row">
      <div class="meta">
        <span class="title">${cat.title_en || cat.id} / ${cat.title_ko || ''}</span>
        <span class="date">order: ${cat.order || 0}</span>
      </div>
      <div class="item-actions">
        <button class="icon-btn" onclick="editCategory('${cat.id}')">&#9998;</button>
        <button class="icon-btn danger" onclick="deleteCategory('${cat.id}')">&#128465;</button>
      </div>
    </div>`).join('') || '<div style="padding: 20px; color: #6b7280; text-align: center;">No categories</div>';
}

function newCategory() {
  showCategoryEditor(null);
}

function editCategory(id) {
  const cat = guideCategories.find(c => c.id === id);
  if (cat) showCategoryEditor(cat);
}

function showCategoryEditor(cat) {
  const editor = document.getElementById('category-editor');
  const isNew = !cat;
  editor.style.display = 'block';
  editor.innerHTML = `
    <div class="editor-form">
      <h3>${isNew ? 'New Category' : 'Edit Category'}</h3>
      <div class="form-row">
        <div class="form-group">
          <label>ID (slug)</label>
          <input id="cat-id" value="${cat ? cat.id : ''}" placeholder="getting-started" ${cat ? 'disabled' : ''}>
        </div>
        <div class="form-group">
          <label>Order</label>
          <input id="cat-order" type="number" value="${cat ? (cat.order || 1) : (guideCategories.length + 1)}">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Title (EN)</label>
          <input id="cat-title-en" value="${cat ? (cat.title_en || '') : ''}" placeholder="Getting Started">
        </div>
        <div class="form-group">
          <label>Title (KO)</label>
          <input id="cat-title-ko" value="${cat ? (cat.title_ko || '') : ''}" placeholder="\uc2dc\uc791\ud558\uae30">
        </div>
      </div>
      <div class="form-actions">
        <button class="btn-cancel" onclick="document.getElementById('category-editor').style.display='none'">${t('admin.cancel')}</button>
        <button class="btn-save" onclick="saveCategory('${cat ? cat.id : ''}')">${t('admin.save')}</button>
      </div>
    </div>`;
}

async function saveCategory(existingId) {
  const db = getDb();
  if (!db) return;

  const docId = existingId || document.getElementById('cat-id').value.trim();
  if (!docId) return;

  const data = {
    title_en: document.getElementById('cat-title-en').value.trim(),
    title_ko: document.getElementById('cat-title-ko').value.trim(),
    order: parseInt(document.getElementById('cat-order').value) || 1
  };

  try {
    await db.collection('guide_categories').doc(docId).set(data, { merge: true });
    showToast(t('admin.saved'), 'success');
    document.getElementById('category-editor').style.display = 'none';
    await loadAllData();
  } catch (err) {
    showToast(t('admin.save_error') + ': ' + err.message, 'error');
  }
}

async function deleteCategory(id) {
  if (!confirm(t('admin.delete_confirm'))) return;
  const db = getDb();
  if (!db) return;

  try {
    await db.collection('guide_categories').doc(id).delete();
    showToast(t('admin.deleted'), 'success');
    await loadAllData();
  } catch (err) {
    showToast(t('admin.save_error') + ': ' + err.message, 'error');
  }
}

/* ══════════════════════════════════════════════════════
   GUIDE ARTICLES CRUD
   ══════════════════════════════════════════════════════ */

function renderArticlesList() {
  const container = document.getElementById('articles-list');
  container.innerHTML = guideArticles.map(art => {
    const cat = guideCategories.find(c => c.id === art.category_id);
    const catName = cat ? cat.title_en : art.category_id;
    return `
      <div class="item-row">
        <div class="meta">
          <span class="tag minor">${catName}</span>
          <span class="title">${art.title_en || art.id}</span>
          <span class="date">order: ${art.order || 0}</span>
        </div>
        <div class="item-actions">
          <button class="icon-btn" onclick="editArticle('${art.id}')">&#9998;</button>
          <button class="icon-btn danger" onclick="deleteArticle('${art.id}')">&#128465;</button>
        </div>
      </div>`;
  }).join('') || '<div style="padding: 20px; color: #6b7280; text-align: center;">No articles</div>';
}

function newArticle() {
  showArticleEditor(null);
}

function editArticle(id) {
  const art = guideArticles.find(a => a.id === id);
  if (art) showArticleEditor(art);
}

function showArticleEditor(art) {
  const editor = document.getElementById('article-editor');
  const isNew = !art;
  editor.style.display = 'block';

  const catOptions = guideCategories.map(c =>
    `<option value="${c.id}" ${art && art.category_id === c.id ? 'selected' : ''}>${c.title_en}</option>`
  ).join('');

  editor.innerHTML = `
    <div class="editor-form">
      <h3>${isNew ? 'New Article' : 'Edit Article'}</h3>
      <div class="form-row">
        <div class="form-group">
          <label>ID (slug)</label>
          <input id="art-id" value="${art ? art.id : ''}" placeholder="installation" ${art ? 'disabled' : ''}>
        </div>
        <div class="form-group">
          <label>Category</label>
          <select id="art-category">${catOptions}</select>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Order</label>
          <input id="art-order" type="number" value="${art ? (art.order || 1) : (guideArticles.length + 1)}">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label>Title (EN)</label>
          <input id="art-title-en" value="${art ? (art.title_en || '') : ''}" placeholder="Installation Guide">
        </div>
        <div class="form-group">
          <label>Title (KO)</label>
          <input id="art-title-ko" value="${art ? (art.title_ko || '') : ''}" placeholder="\uc124\uce58 \uac00\uc774\ub4dc">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group full">
          <label>Content (EN) — Markdown</label>
          <button class="preview-toggle" onclick="togglePreview('art-preview-en', 'art-content-en')">${t('admin.preview')}</button>
          <textarea id="art-content-en" oninput="updatePreview('art-preview-en', this.value)">${art ? (art.content_en || '') : ''}</textarea>
          <div id="art-preview-en" class="preview-box md-content"></div>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group full">
          <label>Content (KO) — Markdown</label>
          <button class="preview-toggle" onclick="togglePreview('art-preview-ko', 'art-content-ko')">${t('admin.preview')}</button>
          <textarea id="art-content-ko" oninput="updatePreview('art-preview-ko', this.value)">${art ? (art.content_ko || '') : ''}</textarea>
          <div id="art-preview-ko" class="preview-box md-content"></div>
        </div>
      </div>
      <div class="form-actions">
        <button class="btn-cancel" onclick="document.getElementById('article-editor').style.display='none'">${t('admin.cancel')}</button>
        <button class="btn-save" onclick="saveArticle('${art ? art.id : ''}')">${t('admin.save')}</button>
      </div>
    </div>`;
}

async function saveArticle(existingId) {
  const db = getDb();
  if (!db) return;

  const docId = existingId || document.getElementById('art-id').value.trim();
  if (!docId) return;

  const data = {
    category_id: document.getElementById('art-category').value,
    order: parseInt(document.getElementById('art-order').value) || 1,
    title_en: document.getElementById('art-title-en').value.trim(),
    title_ko: document.getElementById('art-title-ko').value.trim(),
    content_en: document.getElementById('art-content-en').value,
    content_ko: document.getElementById('art-content-ko').value,
    updated_at: firebase.firestore.FieldValue.serverTimestamp()
  };

  if (!existingId) {
    data.created_at = firebase.firestore.FieldValue.serverTimestamp();
  }

  try {
    await db.collection('guide_articles').doc(docId).set(data, { merge: true });
    showToast(t('admin.saved'), 'success');
    document.getElementById('article-editor').style.display = 'none';
    await loadAllData();
  } catch (err) {
    showToast(t('admin.save_error') + ': ' + err.message, 'error');
  }
}

async function deleteArticle(id) {
  if (!confirm(t('admin.delete_confirm'))) return;
  const db = getDb();
  if (!db) return;

  try {
    await db.collection('guide_articles').doc(id).delete();
    showToast(t('admin.deleted'), 'success');
    await loadAllData();
  } catch (err) {
    showToast(t('admin.save_error') + ': ' + err.message, 'error');
  }
}

/* ── Markdown Preview ────────────────────────────────── */
function togglePreview(previewId, textareaId) {
  const preview = document.getElementById(previewId);
  preview.classList.toggle('open');
  if (preview.classList.contains('open')) {
    const textarea = document.getElementById(textareaId);
    updatePreview(previewId, textarea.value);
  }
}

function updatePreview(previewId, md) {
  const preview = document.getElementById(previewId);
  if (preview && preview.classList.contains('open') && typeof marked !== 'undefined') {
    preview.innerHTML = marked.parse(md || '');
  }
}

/* ── Toast ────────────────────────────────────────────── */
function showToast(message, type) {
  const toast = document.getElementById('toast');
  toast.textContent = message;
  toast.className = 'toast ' + type;
  setTimeout(() => toast.classList.add('show'), 10);
  setTimeout(() => toast.classList.remove('show'), 3000);
}

/* ── Init ─────────────────────────────────────────────── */
function onLangChange() {
  // Re-render UI on language change
  renderReleasesList();
  renderCategoriesList();
  renderArticlesList();
}

initAuth();
</script>
</body>
</html>
