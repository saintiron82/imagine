<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Board — Imagine</title>
<meta name="description" content="Imagine community board — notices, discussions, and inquiries.">
<meta name="theme-color" content="#0a0a1a">
<link rel="icon" href="icon.svg" type="image/svg+xml">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="common.css">
<style>
.board-wrap {
  max-width: 860px; margin: 0 auto;
  padding: 100px 24px 80px;
  min-height: calc(100vh - 64px);
}
</style>
</head>
<body>

<div class="ambient"></div>

<!-- Nav -->
<nav>
  <div class="nav-inner">
    <a href="index.html" class="nav-brand">
      <img src="icon.svg" alt="Imagine">
      <span>Imagine</span>
    </a>
    <div class="nav-links">
      <a href="board.html" class="nav-page-link" data-i18n="nav.board">Board</a>
      <a href="release.html" class="nav-page-link" data-i18n="nav.release">Release</a>
      <a href="index.html#download" class="nav-page-link" data-i18n="nav.download">Download</a>
      <div class="lang-toggle">
        <button class="lang-btn active" onclick="setLang('en')">EN</button>
        <button class="lang-btn" onclick="setLang('ko')">KO</button>
      </div>
    </div>
  </div>
</nav>

<!-- Board -->
<div class="board-wrap">
  <!-- Search -->
  <div class="board-search" id="board-search">
    <input type="text" id="search-input" data-i18n-placeholder="search.placeholder" placeholder="Search posts..." oninput="onSearchInput(this.value)">
    <button class="search-clear" id="search-clear" onclick="clearSearch()" style="display:none">&times;</button>
  </div>

  <!-- Tabs -->
  <div class="board-tabs" id="board-tabs">
    <button class="board-tab active" onclick="switchCategory('notice')" data-cat="notice" data-i18n="board.notice">Notice</button>
    <button class="board-tab" onclick="switchCategory('free')" data-cat="free" data-i18n="board.free">Free</button>
    <button class="board-tab" onclick="switchCategory('inquiry')" data-cat="inquiry" data-i18n="board.inquiry">Inquiry</button>
  </div>

  <!-- Content area (list / detail / form) -->
  <div id="board-content">
    <div class="loading" data-i18n="common.loading">Loading...</div>
  </div>
</div>

<!-- Footer -->
<footer>
  <div class="container">
    <p>&copy; 2026 Imagine &middot; Open Source &middot; Apache 2.0</p>
  </div>
</footer>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.14.1/firebase-storage-compat.js"></script>
<script src="common.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marked@15/marked.min.js"></script>

<script>
/* ── Page i18n ───────────────────────────────────────── */
registerPageI18n({
  en: {
    "board.notice": "Notice",
    "board.free": "Free",
    "board.inquiry": "Inquiry",
    "board.write": "+ Write",
    "board.empty": "No posts yet",
    "board.back": "\u2190 Back to list",
    "board.edit": "Edit",
    "board.delete": "Delete",
    "board.confirm_delete": "Delete this post?",
    "board.title_label": "Title",
    "board.content_label": "Content",
    "board.private_label": "Private (only you and admin can see)",
    "board.save": "Save",
    "board.cancel": "Cancel",
    "board.preview": "Preview",
    "board.saved": "Saved",
    "board.deleted": "Deleted",
    "board.title_placeholder": "Enter title",
    "board.content_placeholder": "Write in Markdown...",
    "board.post_count": "{count} posts",
    "comment.title": "Comments",
    "comment.placeholder": "Write a comment...",
    "comment.submit": "Submit",
    "comment.delete": "Delete",
    "comment.confirm_delete": "Delete this comment?",
    "comment.saved": "Comment posted",
    "comment.deleted": "Comment deleted",
    "comment.empty": "No comments yet",
    "comment.count": "{count} comments",
    "attach.label": "Attachments",
    "attach.hint": "Max 5 files, 5MB each (images, PDF)",
    "attach.hint_comment": "Max 2 files, 5MB each",
    "attach.uploading": "Uploading...",
    "attach.remove": "Remove",
    "attach.download": "Download",
    "attach.too_large": "File too large (max 5MB)",
    "attach.too_many": "Too many files",
    "search.placeholder": "Search posts...",
    "search.results": "Search results ({count})",
    "search.no_results": "No posts found"
  },
  ko: {
    "board.notice": "\uacf5\uc9c0",
    "board.free": "\uc790\uc720",
    "board.inquiry": "\ubb38\uc758",
    "board.write": "+ \uae00\uc4f0\uae30",
    "board.empty": "\uc544\uc9c1 \uae00\uc774 \uc5c6\uc2b5\ub2c8\ub2e4",
    "board.back": "\u2190 \ubaa9\ub85d\uc73c\ub85c",
    "board.edit": "\uc218\uc815",
    "board.delete": "\uc0ad\uc81c",
    "board.confirm_delete": "\uc774 \uae00\uc744 \uc0ad\uc81c\ud558\uc2dc\uaca0\uc2b5\ub2c8\uae4c?",
    "board.title_label": "\uc81c\ubaa9",
    "board.content_label": "\ub0b4\uc6a9",
    "board.private_label": "\ube44\uacf5\uac1c (\ubcf8\uc778\uacfc \uad00\ub9ac\uc790\ub9cc \ubcfc \uc218 \uc788\uc74c)",
    "board.save": "\uc800\uc7a5",
    "board.cancel": "\ucde8\uc18c",
    "board.preview": "\ubbf8\ub9ac\ubcf4\uae30",
    "board.saved": "\uc800\uc7a5\ub418\uc5c8\uc2b5\ub2c8\ub2e4",
    "board.deleted": "\uc0ad\uc81c\ub418\uc5c8\uc2b5\ub2c8\ub2e4",
    "board.title_placeholder": "\uc81c\ubaa9\uc744 \uc785\ub825\ud558\uc138\uc694",
    "board.content_placeholder": "Markdown\uc73c\ub85c \uc791\uc131\ud558\uc138\uc694...",
    "board.post_count": "{count}\uac1c\uc758 \uae00",
    "comment.title": "\ub313\uae00",
    "comment.placeholder": "\ub313\uae00\uc744 \uc785\ub825\ud558\uc138\uc694...",
    "comment.submit": "\ub4f1\ub85d",
    "comment.delete": "\uc0ad\uc81c",
    "comment.confirm_delete": "\uc774 \ub313\uae00\uc744 \uc0ad\uc81c\ud558\uc2dc\uaca0\uc2b5\ub2c8\uae4c?",
    "comment.saved": "\ub313\uae00\uc774 \ub4f1\ub85d\ub418\uc5c8\uc2b5\ub2c8\ub2e4",
    "comment.deleted": "\ub313\uae00\uc774 \uc0ad\uc81c\ub418\uc5c8\uc2b5\ub2c8\ub2e4",
    "comment.empty": "\uc544\uc9c1 \ub313\uae00\uc774 \uc5c6\uc2b5\ub2c8\ub2e4",
    "comment.count": "\ub313\uae00 {count}\uac1c",
    "attach.label": "\ucca8\ubd80\ud30c\uc77c",
    "attach.hint": "\ucd5c\ub300 5\uac1c, \ud30c\uc77c\ub2f9 5MB (\uc774\ubbf8\uc9c0, PDF)",
    "attach.hint_comment": "\ucd5c\ub300 2\uac1c, \ud30c\uc77c\ub2f9 5MB",
    "attach.uploading": "\uc5c5\ub85c\ub4dc \uc911...",
    "attach.remove": "\uc81c\uac70",
    "attach.download": "\ub2e4\uc6b4\ub85c\ub4dc",
    "attach.too_large": "\ud30c\uc77c\uc774 \ub108\ubb34 \ud07d\ub2c8\ub2e4 (\ucd5c\ub300 5MB)",
    "attach.too_many": "\ud30c\uc77c\uc774 \ub108\ubb34 \ub9ce\uc2b5\ub2c8\ub2e4",
    "search.placeholder": "\uac8c\uc2dc\uae00 \uac80\uc0c9...",
    "search.results": "\uac80\uc0c9 \uacb0\uacfc ({count}\uac1c)",
    "search.no_results": "\uac80\uc0c9 \uacb0\uacfc\uac00 \uc5c6\uc2b5\ub2c8\ub2e4"
  }
});

/* ── State ───────────────────────────────────────────── */
let currentCategory = 'notice';
let currentUser = null;
let postsCache = {};
let _pendingExistingAttachments = [];
let _searchTimer = null;
let _isSearchMode = false;

function getUser() {
  return currentUser || (getAuth() && getAuth().currentUser) || null;
}

/* ── Init ────────────────────────────────────────────── */
initFirebase(); // Ensure Firebase is ready before requireAuth
requireAuth().then(user => {
  if (!user) return;
  currentUser = user;

  // Restore category from hash
  const hash = window.location.hash.slice(1);
  if (['notice', 'free', 'inquiry'].includes(hash)) {
    currentCategory = hash;
  }
  updateTabs();
  loadPosts();
});

/* ── Category Switching ──────────────────────────────── */
function switchCategory(cat) {
  currentCategory = cat;
  _isSearchMode = false;
  const input = document.getElementById('search-input');
  if (input) input.value = '';
  const clearBtn = document.getElementById('search-clear');
  if (clearBtn) clearBtn.style.display = 'none';
  history.replaceState(null, '', '#' + cat);
  updateTabs();
  loadPosts();
}

function updateTabs() {
  document.querySelectorAll('.board-tab').forEach(btn => {
    btn.classList.toggle('active', btn.dataset.cat === currentCategory);
  });
}

/* ── Search ──────────────────────────────────────────── */
function onSearchInput(value) {
  const clearBtn = document.getElementById('search-clear');
  if (clearBtn) clearBtn.style.display = value ? 'block' : 'none';

  clearTimeout(_searchTimer);
  _searchTimer = setTimeout(() => {
    if (value.trim()) {
      searchPosts(value.trim());
    } else {
      clearSearch();
    }
  }, 300);
}

function clearSearch() {
  _isSearchMode = false;
  const input = document.getElementById('search-input');
  if (input) input.value = '';
  const clearBtn = document.getElementById('search-clear');
  if (clearBtn) clearBtn.style.display = 'none';
  document.getElementById('board-tabs').style.display = '';
  loadPosts();
}

async function searchPosts(query) {
  const content = document.getElementById('board-content');
  const db = getDb();
  if (!db) return;

  _isSearchMode = true;
  document.getElementById('board-tabs').style.display = 'none';
  content.innerHTML = '<div class="loading">' + t('common.loading') + '</div>';

  try {
    // Load all posts across all categories
    const snap = await db.collection('posts')
      .orderBy('created_at', 'desc')
      .get();

    const q = query.toLowerCase();
    const u = getUser();

    let results = snap.docs
      .map(d => ({ id: d.id, ...d.data() }))
      .filter(p => {
        // Skip private inquiries from others
        if (p.category === 'inquiry' && p.is_private) {
          if (!u || (p.author_email !== u.email && !isAdmin(u))) return false;
        }
        // Match title or content
        const title = (p.title || '').toLowerCase();
        const body = (p.content || '').toLowerCase();
        const author = (p.author_name || '').toLowerCase();
        return title.includes(q) || body.includes(q) || author.includes(q);
      });

    postsCache = {};
    results.forEach(p => { postsCache[p.id] = p; });

    renderSearchResults(results, content, query);
  } catch (err) {
    console.error('Search failed:', err);
    content.innerHTML = '<div class="empty-state"><div class="icon">&#9888;</div><p>' + t('common.error') + '</p></div>';
  }
}

function renderSearchResults(posts, container, query) {
  let html = '<div class="board-header">';
  html += '<span class="board-count">' + t('search.results').replace('{count}', posts.length) + '</span>';
  html += '</div>';

  if (posts.length === 0) {
    html += '<div class="empty-state"><div class="icon">&#128269;</div><p>' + t('search.no_results') + '</p></div>';
    container.innerHTML = html;
    return;
  }

  html += '<div class="post-list">';
  posts.forEach(p => {
    const date = p.created_at
      ? (p.created_at.toDate ? p.created_at.toDate() : new Date(p.created_at)).toLocaleDateString()
      : '';
    const privateBadge = p.is_private ? '<span class="badge-private">&#128274;</span>' : '';
    const catLabel = t('board.' + p.category) || p.category;
    html += `
      <div class="post-row" onclick="viewPost('${p.id}')">
        <div class="post-row-title"><span class="badge-cat">${escHtml(catLabel)}</span>${privateBadge}${escHtml(p.title || '')}</div>
        <div class="post-row-author">${escHtml(p.author_name || '')}</div>
        <div class="post-row-date">${date}</div>
      </div>`;
  });
  html += '</div>';

  container.innerHTML = html;
}

/* ── Load Posts ──────────────────────────────────────── */
async function loadPosts() {
  const content = document.getElementById('board-content');
  const db = getDb();
  if (!db) { renderPostList([], content); return; }

  content.innerHTML = '<div class="loading">' + t('common.loading') + '</div>';

  try {
    const snap = await db.collection('posts')
      .where('category', '==', currentCategory)
      .orderBy('created_at', 'desc')
      .get();

    let posts = snap.docs.map(d => ({ id: d.id, ...d.data() }));

    // Filter private inquiry posts (client-side)
    if (currentCategory === 'inquiry') {
      const u = getUser();
      posts = posts.filter(p =>
        !p.is_private
        || (u && p.author_email === u.email)
        || isAdmin(u)
      );
    }

    postsCache = {};
    posts.forEach(p => { postsCache[p.id] = p; });

    renderPostList(posts, content);
  } catch (err) {
    console.error('Failed to load posts:', err);
    const canWrite = currentCategory !== 'notice' || isAdmin(getUser());
    let html = '<div class="board-header">';
    html += '<span class="board-count"></span>';
    if (canWrite) {
      html += '<button class="btn-write" onclick="showWriteForm()">' + t('board.write') + '</button>';
    }
    html += '</div>';
    html += '<div class="empty-state"><div class="icon">&#9888;</div><p>' + t('common.error') + '</p></div>';
    content.innerHTML = html;
  }
}

/* ── Render Post List ────────────────────────────────── */
function renderPostList(posts, container) {
  const canWrite = currentCategory !== 'notice' || isAdmin(getUser());

  let html = '<div class="board-header">';
  html += '<span class="board-count">' + t('board.post_count').replace('{count}', posts.length) + '</span>';
  if (canWrite) {
    html += '<button class="btn-write" onclick="showWriteForm()">' + t('board.write') + '</button>';
  }
  html += '</div>';

  if (posts.length === 0) {
    html += '<div class="empty-state"><div class="icon">&#128196;</div><p>' + t('board.empty') + '</p></div>';
    container.innerHTML = html;
    return;
  }

  html += '<div class="post-list">';
  posts.forEach(p => {
    const date = p.created_at
      ? (p.created_at.toDate ? p.created_at.toDate() : new Date(p.created_at)).toLocaleDateString()
      : '';
    const privateBadge = p.is_private ? '<span class="badge-private">&#128274;</span>' : '';
    html += `
      <div class="post-row" onclick="viewPost('${p.id}')">
        <div class="post-row-title">${privateBadge}${escHtml(p.title || '')}</div>
        <div class="post-row-author">${escHtml(p.author_name || '')}</div>
        <div class="post-row-date">${date}</div>
      </div>`;
  });
  html += '</div>';

  container.innerHTML = html;
}

/* ── View Post ───────────────────────────────────────── */
function viewPost(postId) {
  const post = postsCache[postId];
  if (!post) return;

  const container = document.getElementById('board-content');
  const htmlContent = typeof marked !== 'undefined'
    ? marked.parse(post.content || '')
    : (post.content || '').replace(/\n/g, '<br>');

  const date = post.created_at
    ? (post.created_at.toDate ? post.created_at.toDate() : new Date(post.created_at)).toLocaleDateString()
    : '';

  const u = getUser();
  const canEdit = u && (post.author_email === u.email || isAdmin(u));

  let html = `
    <button class="btn-back" onclick="loadPosts()">${t('board.back')}</button>
    <div class="post-detail">
      <h1 class="post-detail-title">${escHtml(post.title || '')}</h1>
      <div class="post-meta">
        ${escHtml(post.author_name || '')} &middot; ${date}
        ${post.is_private ? ' &middot; <span class="badge-private">&#128274;</span>' : ''}
      </div>
      <div class="post-body md-content">${htmlContent}</div>`;

  if (canEdit) {
    html += `
      <div class="post-actions">
        <button class="btn-cancel" onclick="showWriteForm('${post.id}')">${t('board.edit')}</button>
        <button class="btn-danger" onclick="deletePost('${post.id}')">${t('board.delete')}</button>
      </div>`;
  }

  html += `<div class="comment-section" id="comments-${escAttr(post.id)}"></div>`;
  html += '</div>';
  container.innerHTML = html;
  loadComments(post.id);
}

/* ── Write / Edit Form ───────────────────────────────── */
function showWriteForm(postId) {
  const post = postId ? postsCache[postId] : null;
  const container = document.getElementById('board-content');
  const isInquiry = currentCategory === 'inquiry';

  let html = `
    <button class="btn-back" onclick="loadPosts()">${t('board.cancel')}</button>
    <div class="post-form">
      <div class="form-group">
        <label>${t('board.title_label')}</label>
        <input type="text" id="post-title" placeholder="${t('board.title_placeholder')}" value="${escAttr(post ? post.title : '')}">
      </div>
      <div class="form-group">
        <label>${t('board.content_label')}</label>
        <button class="preview-toggle" onclick="togglePreview()">${t('board.preview')}</button>
        <textarea id="post-content" placeholder="${t('board.content_placeholder')}">${escHtml(post ? post.content : '')}</textarea>
        <div class="preview-box" id="preview-box"></div>
      </div>`;

  if (isInquiry) {
    const checked = post && post.is_private ? 'checked' : '';
    html += `
      <div class="form-group">
        <div class="checkbox-row">
          <input type="checkbox" id="post-private" ${checked}>
          <label for="post-private">${t('board.private_label')}</label>
        </div>
      </div>`;
  }

  // Inline file upload button (uploads immediately, inserts Markdown)
  html += `
      <div class="form-group">
        <label>${t('attach.label')}</label>
        <div class="file-upload-area">
          <input type="file" id="post-files" multiple accept="image/jpeg,image/png,image/gif,image/webp,.pdf" onchange="insertPostFiles(this)">
        </div>
        <small class="file-hint">${t('attach.hint')}</small>
      </div>`;

  html += `
      <div class="form-actions">
        <button class="btn-save" onclick="savePost('${postId || ''}')">${t('board.save')}</button>
        <button class="btn-cancel" onclick="loadPosts()">${t('board.cancel')}</button>
      </div>
    </div>`;

  container.innerHTML = html;
}

/* ── Save Post ───────────────────────────────────────── */
async function savePost(postId) {
  const title = document.getElementById('post-title').value.trim();
  const content = document.getElementById('post-content').value.trim();
  const privateEl = document.getElementById('post-private');
  const isPrivate = privateEl ? privateEl.checked : false;

  if (!title) { document.getElementById('post-title').focus(); return; }

  const db = getDb();
  if (!db) return;

  const data = {
    category: currentCategory,
    title: title,
    content: content,
    is_private: isPrivate,
    updated_at: firebase.firestore.FieldValue.serverTimestamp()
  };

  const user = getUser();
  if (!user) { showToast('Please sign in first', 'error'); return; }

  try {
    if (postId) {
      await db.collection('posts').doc(postId).update(data);
    } else {
      data.author_email = user.email;
      data.author_name = user.displayName || user.email.split('@')[0];
      data.created_at = firebase.firestore.FieldValue.serverTimestamp();
      await db.collection('posts').add(data);
    }
    showToast(t('board.saved'), 'success');
    loadPosts();
  } catch (err) {
    console.error('Save failed:', err);
    showToast(err.message, 'error');
  }
}

/* ── Delete Post ─────────────────────────────────────── */
async function deletePost(postId) {
  if (!confirm(t('board.confirm_delete'))) return;

  const db = getDb();
  if (!db) return;

  try {
    await db.collection('posts').doc(postId).delete();
    showToast(t('board.deleted'), 'success');
    loadPosts();
  } catch (err) {
    console.error('Delete failed:', err);
    showToast(err.message, 'error');
  }
}

/* ── Preview Toggle ──────────────────────────────────── */
function togglePreview() {
  const box = document.getElementById('preview-box');
  const textarea = document.getElementById('post-content');
  box.classList.toggle('open');
  if (box.classList.contains('open') && typeof marked !== 'undefined') {
    box.innerHTML = '<div class="md-content">' + marked.parse(textarea.value || '') + '</div>';
  }
}

/* ── Comments ────────────────────────────────────────── */
async function loadComments(postId) {
  const section = document.getElementById('comments-' + postId);
  if (!section) return;

  const db = getDb();
  if (!db) return;

  try {
    const snap = await db.collection('posts').doc(postId)
      .collection('comments').orderBy('created_at', 'asc').get();

    const comments = snap.docs.map(d => ({ id: d.id, ...d.data() }));
    const u = getUser();

    let html = `<div class="comment-header-row">
      <h3>${t('comment.title')}</h3>
      <span class="comment-count">${t('comment.count').replace('{count}', comments.length)}</span>
    </div>`;

    if (comments.length === 0) {
      html += '<p class="comment-empty">' + t('comment.empty') + '</p>';
    } else {
      html += '<div class="comment-list">';
      comments.forEach(c => {
        const date = c.created_at
          ? (c.created_at.toDate ? c.created_at.toDate() : new Date(c.created_at)).toLocaleDateString()
          : '';
        const canDel = u && (c.author_email === u.email || isAdmin(u));
        let attachHtml = '';
        if (c.attachments && c.attachments.length > 0) {
          attachHtml = '<div class="comment-attachments">';
          c.attachments.forEach(a => {
            if (a.type && a.type.startsWith('image/')) {
              attachHtml += `<a href="${escAttr(a.url)}" target="_blank" class="attachment-img-link"><img src="${escAttr(a.url)}" alt="${escAttr(a.name)}" class="attachment-img attachment-img-sm"></a>`;
            } else {
              attachHtml += `<a href="${escAttr(a.url)}" target="_blank" class="attachment-file">${escHtml(a.name)} <small>(${formatFileSize(a.size)})</small></a>`;
            }
          });
          attachHtml += '</div>';
        }
        html += `
          <div class="comment-item">
            <div class="comment-item-head">
              <span class="comment-author">${escHtml(c.author_name || '')} &middot; ${date}</span>
              ${canDel ? `<button class="comment-delete-btn" onclick="deleteComment('${escAttr(postId)}','${escAttr(c.id)}')">${t('comment.delete')}</button>` : ''}
            </div>
            <div class="comment-item-body">${escHtml(c.content || '').replace(/\n/g, '<br>')}</div>
            ${attachHtml}
          </div>`;
      });
      html += '</div>';
    }

    html += `
      <div class="comment-form">
        <textarea id="comment-input" placeholder="${t('comment.placeholder')}"></textarea>
        <div class="comment-form-bottom">
          <label class="comment-file-label">
            <input type="file" id="comment-files" multiple accept="image/jpeg,image/png,image/gif,image/webp,.pdf" onchange="onFileSelect(this, 2)" style="display:none">
            <span class="comment-attach-btn" title="${t('attach.label')}">&#128206;</span>
          </label>
          <small class="comment-file-hint">${t('attach.hint_comment')}</small>
          <button class="btn-save comment-submit" onclick="saveComment('${escAttr(postId)}')">${t('comment.submit')}</button>
        </div>
      </div>`;

    section.innerHTML = html;
  } catch (err) {
    console.error('Failed to load comments:', err);
    section.innerHTML = '';
  }
}

async function saveComment(postId) {
  const input = document.getElementById('comment-input');
  const content = input ? input.value.trim() : '';
  if (!content) { if (input) input.focus(); return; }

  const db = getDb();
  if (!db) return;
  const user = getUser();
  if (!user) { showToast('Please sign in first', 'error'); return; }

  try {
    const commentData = {
      content: content,
      author_email: user.email,
      author_name: user.displayName || user.email.split('@')[0],
      created_at: firebase.firestore.FieldValue.serverTimestamp()
    };

    // Handle comment file attachments
    const fileInput = document.getElementById('comment-files');
    const newFiles = fileInput ? fileInput.files : [];
    if (newFiles.length > 0) {
      if (newFiles.length > 2) {
        showToast(t('attach.too_many'), 'error'); return;
      }
      showToast(t('attach.uploading'), 'success');
      const uploaded = await uploadFiles(newFiles, 'comments/' + postId + '/' + Date.now());
      commentData.attachments = uploaded;
    }

    await db.collection('posts').doc(postId).collection('comments').add(commentData);
    showToast(t('comment.saved'), 'success');
    loadComments(postId);
  } catch (err) {
    console.error('Comment save failed:', err);
    showToast(err.message, 'error');
  }
}

async function deleteComment(postId, commentId) {
  if (!confirm(t('comment.confirm_delete'))) return;

  const db = getDb();
  if (!db) return;

  try {
    await db.collection('posts').doc(postId).collection('comments').doc(commentId).delete();
    showToast(t('comment.deleted'), 'success');
    loadComments(postId);
  } catch (err) {
    console.error('Comment delete failed:', err);
    showToast(err.message, 'error');
  }
}

/* ── Toast ───────────────────────────────────────────── */
function showToast(message, type) {
  const existing = document.querySelector('.toast');
  if (existing) existing.remove();
  const el = document.createElement('div');
  el.className = 'toast ' + (type || 'success');
  el.textContent = message;
  document.body.appendChild(el);
  setTimeout(() => el.remove(), 3000);
}

/* ── Language Change ─────────────────────────────────── */
function onLangChange() {
  const input = document.getElementById('search-input');
  if (input) input.placeholder = t('search.placeholder');
  if (_isSearchMode && input && input.value.trim()) {
    searchPosts(input.value.trim());
  } else {
    loadPosts();
  }
}

/* ── Hash Change ─────────────────────────────────────── */
window.addEventListener('hashchange', () => {
  const hash = window.location.hash.slice(1);
  if (['notice', 'free', 'inquiry'].includes(hash)) {
    switchCategory(hash);
  }
});

/* ── File Upload Helpers ─────────────────────────────── */
async function uploadFiles(files, pathPrefix) {
  const st = getStorage();
  if (!st) throw new Error('Storage not available');

  const MAX_SIZE = 5 * 1024 * 1024;
  const ALLOWED = ['image/jpeg','image/png','image/gif','image/webp','application/pdf'];
  const results = [];

  for (let i = 0; i < files.length; i++) {
    const file = files[i];
    if (file.size > MAX_SIZE) throw new Error(t('attach.too_large') + ': ' + file.name);
    if (!ALLOWED.includes(file.type)) continue;

    const safeName = Date.now() + '_' + file.name.replace(/[^a-zA-Z0-9._-]/g, '_');
    const ref = st.ref('board/' + pathPrefix + '/' + safeName);
    await ref.put(file);
    const url = await ref.getDownloadURL();
    results.push({ name: file.name, url: url, size: file.size, type: file.type });
  }
  return results;
}

function formatFileSize(bytes) {
  if (!bytes || bytes === 0) return '0 B';
  if (bytes < 1024) return bytes + ' B';
  if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
  return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
}

function onFileSelect(input, maxFiles) {
  if (input.files.length > maxFiles) {
    showToast(t('attach.too_many'), 'error');
    input.value = '';
  }
}

/* Upload immediately on file select, insert Markdown into textarea */
async function insertPostFiles(input) {
  const files = input.files;
  if (!files || files.length === 0) return;

  const textarea = document.getElementById('post-content');
  if (!textarea) return;

  input.disabled = true;
  showToast(t('attach.uploading'), 'success');

  try {
    const uploaded = await uploadFiles(files, 'posts/' + Date.now());
    let md = '';
    uploaded.forEach(a => {
      if (a.type && a.type.startsWith('image/')) {
        md += `![${a.name}](${a.url})\n`;
      } else {
        md += `[${a.name} (${formatFileSize(a.size)})](${a.url})\n`;
      }
    });

    // Insert at cursor position
    const pos = textarea.selectionStart || textarea.value.length;
    const before = textarea.value.substring(0, pos);
    const after = textarea.value.substring(pos);
    const sep = before.length > 0 && !before.endsWith('\n') ? '\n' : '';
    textarea.value = before + sep + md + after;
    textarea.focus();
  } catch (err) {
    showToast(err.message, 'error');
  } finally {
    input.value = '';
    input.disabled = false;
  }
}

/* ── Utilities ───────────────────────────────────────── */
function escHtml(str) {
  const div = document.createElement('div');
  div.textContent = str;
  return div.innerHTML;
}
function escAttr(str) {
  return (str || '').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
}
</script>
</body>
</html>
