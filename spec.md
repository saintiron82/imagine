# Spec.md - ImageParser v2.0 기능 명세서

## 프로젝트 개요

ImageParser는 PSD, PNG, JPG 이미지를 AI 검색 가능한 데이터로 변환하는 Triaxis(V+S+M) 멀티모달 아카이브 시스템입니다. v2.0에서는 UI/UX 개선, 검색 고도화, 성능 최적화, 패키징/배포, 협업 기능을 추가합니다.

---

## 1. UI/UX 개선

### 1.1 이미지 뷰어 강화
- **전체 화면 이미지 프리뷰**: 검색 결과/파일 그리드에서 클릭 시 라이트박스 스타일 뷰어
- **이미지 비교 모드**: 여러 이미지를 나란히 비교 (2~4분할)
- **줌/패닝**: 고해상도 이미지 확대/이동 지원
- **PSD 레이어 시각화**: 레이어 트리를 시각적으로 탐색 (토글 on/off)

### 1.2 검색 UI 개선
- **검색 히스토리**: 최근 검색어 자동 저장/표시
- **검색 제안**: 기존 태그/캡션 기반 자동완성
- **결과 정렬 옵션**: 관련도순, 날짜순, 파일명순, 평점순
- **뷰 모드 전환**: 그리드 / 리스트 / 컴팩트 뷰

### 1.3 레이아웃 개선
- **드래그 앤 드롭 영역**: 파일 드래그로 즉시 처리 시작
- **사이드바 접기/펴기**: 작업 공간 최대화 토글
- **키보드 단축키**: 검색(Ctrl+K), 필터 토글, 네비게이션

### 인수 조건
- [ ] 라이트박스 뷰어에서 좌우 화살표로 이미지 탐색 가능
- [ ] 검색 히스토리 최대 50개 저장 (로컬 스토리지)
- [ ] 그리드/리스트/컴팩트 3가지 뷰 모드 전환

---

## 2. 검색 고도화

### 2.1 고급 필터링
- **날짜 범위 필터**: 파일 수정일/등록일 기준
- **해상도 범위 필터**: 최소/최대 해상도 지정
- **레이어 수 필터**: PSD 레이어 수 범위 지정
- **복합 필터 저장**: 자주 쓰는 필터 조합을 프리셋으로 저장

### 2.2 북마크/컬렉션 시스템
- **컬렉션 생성**: 사용자 정의 이미지 모음 생성
- **컬렉션 공유**: 컬렉션을 JSON으로 내보내기/가져오기
- **스마트 컬렉션**: 자동 필터 기반 동적 컬렉션 (예: "평점 4 이상 + 캐릭터 타입")

### 2.3 유사 이미지 검색
- **"이것과 비슷한" 검색**: 검색 결과에서 특정 이미지 선택 시 유사 이미지 표시
- **다중 참조 검색**: 여러 이미지를 참조로 결합 검색 (AND/OR 모드 확장)

### 2.4 태그 관리
- **태그 자동 제안**: AI 태그 기반 사용자 태그 추천
- **태그 일괄 편집**: 여러 이미지에 동시 태그 추가/제거
- **태그 클라우드**: 전체 태그 분포를 시각화

### 인수 조건
- [ ] 날짜/해상도/레이어 수 필터가 Triaxis 검색과 결합 동작
- [ ] 컬렉션 CRUD (생성/읽기/수정/삭제) 및 JSON 내보내기/가져오기
- [ ] 유사 이미지 검색 시 VV 유사도 활용

---

## 3. 성능 최적화

### 3.1 인덱싱 속도 개선
- **증분 인덱싱**: 변경된 파일만 재처리 (현재 --no-skip 필요한 경우 감소)
- **병렬 파싱**: 멀티프로세스로 파싱/썸네일 생성 병렬화
- **Vision 캐싱**: VLM 결과 캐싱으로 중복 처리 방지

### 3.2 프론트엔드 성능
- **이미지 lazy loading**: 뷰포트 외 이미지 지연 로드 (현재 가상 스크롤 기반 확장)
- **검색 응답 캐싱**: 동일 쿼리 결과 클라이언트 캐시
- **썸네일 WebP 변환**: PNG 대비 용량 50% 감소

### 3.3 메모리 최적화
- **모델 언로드**: 일정 시간 미사용 시 SigLIP2/VLM 자동 언로드
- **DB 연결 풀링**: SQLite WAL 모드 활용 동시 읽기 개선
- **배치 크기 자동 조정**: 가용 VRAM 기반 동적 배치 크기

### 인수 조건
- [ ] 1000개 파일 디렉토리 discover 시 변경 파일만 처리
- [ ] 검색 응답 100ms 이내 (캐시 히트 시)
- [ ] VRAM 6GB 환경에서 OOM 없이 연속 처리

---

## 4. 패키징 및 배포

### 4.1 설치 프로그램
- **Windows NSIS 인스톨러**: Python 런타임 포함 원클릭 설치
- **macOS DMG**: Apple Silicon 네이티브 지원
- **자동 환경 설정**: 첫 실행 시 Ollama 모델 다운로드 가이드

### 4.2 자동 업데이트
- **electron-updater**: GitHub Releases 기반 자동 업데이트 체크
- **델타 업데이트**: 변경된 파일만 다운로드
- **업데이트 알림**: 인앱 알림으로 업데이트 안내

### 4.3 포터블 모드
- **USB 실행**: 설치 없이 포터블 디렉토리에서 실행
- **DB 위치 설정**: 사용자 지정 DB 경로 (외장 드라이브 지원)

### 인수 조건
- [ ] Windows에서 인스톨러 실행 후 3클릭 이내 설치 완료
- [ ] macOS에서 DMG 드래그 설치 지원
- [ ] GitHub Releases에서 자동 업데이트 감지

---

## 5. 협업 기능

### 5.1 공유 아카이브
- **DB 내보내기/가져오기**: 메타데이터+벡터 DB를 단일 파일로 패키징
- **이미지 포함 옵션**: 썸네일 포함/미포함 내보내기
- **선택 내보내기**: 컬렉션/폴더 단위 부분 내보내기

### 5.2 코멘트 시스템
- **이미지별 코멘트**: 텍스트 코멘트 추가 (현재 user_note 확장)
- **코멘트 히스토리**: 시간순 코멘트 이력 관리
- **@멘션**: 팀원 태그 (추후 네트워크 공유 시)

### 5.3 역할/권한 (Future)
- **읽기 전용 공유**: 메타데이터만 공유, 원본 경로 미노출
- **편집 권한**: 태그/카테고리/평점 편집 가능

### 인수 조건
- [ ] DB 내보내기 파일 생성 및 다른 PC에서 가져오기 동작
- [ ] 이미지별 코멘트 CRUD 동작
- [ ] 내보내기 파일에 썸네일 포함/미포함 옵션

---

## 기술 제약 사항

- **DB**: SQLite + sqlite-vec 유지 (PostgreSQL 전환 금지)
- **프론트엔드**: React 19 + Electron 40 + Tailwind CSS 유지
- **백엔드 통신**: IPC -> Python subprocess (stdio JSON) 유지
- **i18n**: 모든 신규 UI 문자열은 en-US.json/ko-KR.json에 키 추가 필수
- **인코딩**: UTF-8 필수 (Windows cp949 의존 금지)
